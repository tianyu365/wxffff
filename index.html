<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="renderer" content="webkit">
    <meta name="layoutmode" content="standard">
    <meta name="imagemode" content="force">
    <meta name="wap-font-scale" content="no">
    <meta name="format-detection" content="telephone=no">
    <title></title>
    
    <meta property="og:type" content="website">
    <meta property="og:title" content="强开">
    <meta property="og:description" content="通过识别码快速访问微信网页">
    <meta property="og:image" content="">
    
    <link rel="shortcut icon" href="" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.staticfile.org/Swiper/3.2.6/css/swiper.min.css">
    <style>
        *{margin:0;padding:0;border:0}
        body,html{min-height:100%;background:#f8f8f8;font-family:Arial,sans-serif}
        body{overflow:hidden}
        iframe{width:100%;height:100vh;border:none}
        .error-content{color:red;font-size:18px;text-align:center;padding:50px;background:#fff;margin:20px;border-radius:10px}
        .loading{text-align:center;padding:50px;color:#666;background:#fff;margin:20px;border-radius:10px}
        .loading-spinner{display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .loading-text{font-size:18px;color:#666;margin-top:20px}
    </style>
</head>
<body>
    <div id="content">
        <div class="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在加载网络数据...</div>
        </div>
    </div>
    
    <script>
        // API配置 - 使用HTTPS域名
        const API_BASE_URL = 'https://wd.wdmg.cloud/admin/api.php';
        
        // 获取URL参数
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // 显示加载动画
        function showLoading() {
            document.getElementById('content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">正在加载网络数据...</div>
                </div>
            `;
        }
        
        // 显示错误信息
        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div class="error-content">
                    <h3>❌ 加载失败</h3>
                    <p>${message}</p>
                    <button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;background:#007cba;color:white;border:none;border-radius:5px;cursor:pointer;">重试</button>
                </div>
            `;
        }
        
        // 显示嵌入网页
        function showEmbeddedPage(url, title = '', description = '') {
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '100vh';
            iframe.style.border = 'none';
            
            // 替换加载内容
            document.getElementById('content').innerHTML = '';
            document.getElementById('content').appendChild(iframe);
            
            // 设置页面标题
            if (title) {
                document.title = title;
            }
            
            // 初始化微信分享
            initWechatShare(title, description, url);
            
            // 处理加载错误
            iframe.onerror = function() {
                showError('网页加载失败，请检查目标网站是否可访问');
            };
            
            // 尝试从iframe获取标题（如果同源）
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.title) {
                        document.title = iframeDoc.title;
                    }
                } catch (e) {
                    // 跨域限制，无法获取标题
                    console.log('无法获取iframe标题（跨域限制）');
                }
            };
        }
        
        // 从API获取嵌入信息
        async function fetchEmbedInfo(embedId) {
            try {
                const response = await fetch(`${API_BASE_URL}?action=get_embed&id=${embedId}`);
                const data = await response.json();
                
                if (data.success) {
                    return {
                        target_url: data.data.target_url,
                        loading_time: data.data.loading_time || 3,
                        title: data.data.title,
                        description: data.data.description
                    };
                } else {
                    throw new Error(data.error || '获取信息失败');
                }
            } catch (error) {
                throw new Error('网络请求失败: ' + error.message);
            }
        }
        
        // 获取全局设置
        async function fetchSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=settings`);
                const data = await response.json();
                
                if (data.success) {
                    return data.data.loading_time;
                } else {
                    return 1; // 默认3秒
                }
            } catch (error) {
                return 1; // 默认3秒
            }
        }
        
        // 主函数
        async function init() {
            const embedId = getUrlParameter('i');
            
            if (embedId) {
                try {
                    // 显示加载动画
                    showLoading();
                    
                    // 获取全局设置
                    const loadingTime = await fetchSettings();
                    
                    // 如果设置了加载时间，等待相应时间
                    if (loadingTime > 0) {
                        await new Promise(resolve => setTimeout(resolve, loadingTime * 1000));
                    }
                    
                    // 从API获取目标URL
                    const embedData = await fetchEmbedInfo(embedId);
                    
                    // 显示嵌入的网页
                    showEmbeddedPage(embedData.target_url, embedData.title, embedData.description);
                    
                } catch (error) {
                    showError(error.message);
                }
            } else {
                // 没有参数时显示使用说明
                document.getElementById('content').innerHTML = `
                <div style="text-align:center;padding:50px;background:#fff;margin:20px;border-radius:10px;">
                </div>
                `;
            }
        }
        
        // 初始化微信分享
        function initWechatShare(title, description, url) {
            // 动态加载微信JS SDK
            if (typeof wx === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://res.wx.qq.com/open/js/jweixin-1.6.0.js';
                script.onload = function() {
                    setupWechatShare(title, description, url);
                };
                document.head.appendChild(script);
            } else {
                setupWechatShare(title, description, url);
            }
        }
        
        // 设置微信分享
        function setupWechatShare(title, description, url) {
            if (typeof wx === 'undefined') return;
            
            // 微信配置
            wx.config({
                debug: false,
                appId: 'wx6fd2e0591c6bfd98',
                timestamp: '1761373466',
                nonceStr: '3sbwdVDmFAjSihnR',
                signature: 'f356f2e524179a8f324696a4965110a8ab2123c6',
                jsApiList: [
                    'updateAppMessageShareData',
                    'updateTimelineShareData',
                ]
            });
            
            // 配置完成后调用ready函数
            wx.ready(function (res) {
                console.log('微信JS配置成功');
                console.log('分享标题:', title);
                console.log('分享描述:', description);
                console.log('分享链接:', url);
                
                // 分享到朋友圈
                wx.updateTimelineShareData({
                    title: title,
                    link: url,
                    imgUrl: 'https://hh.wxshpt.shop/img/4.png',
                    success: function (res) {
                        console.log('朋友圈分享配置成功');
                    },
                    fail: function (res) {
                        console.log('朋友圈分享配置失败:', res);
                    }
                });
                
                // 分享给朋友
                wx.updateAppMessageShareData({
                    title: title,
                    desc: description,
                    link: url,
                    imgUrl: 'https://hh.wxshpt.shop/img/4.png',
                    success: function (res) {
                        console.log('朋友分享配置成功');
                    },
                    fail: function (res) {
                        console.log('朋友分享配置失败:', res);
                    }
                });
            });
            
            // 错误处理
            wx.error(function(res) {
                console.log('微信配置失败:', res);
            });
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
